<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>munet Network Library for muwerk Scheduler: munet</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">munet Network Library for muwerk Scheduler
   </div>
   <div id="projectbrief">A muwerk network library supporting WiFi, NTP, OTA and MQTT for ESP8266 and ESP32 and serial links for all platforms</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">munet </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.org/muwerk/munet"><img src="https://travis-ci.org/muwerk/munet.svg?branch=master" alt="ESP12e build" style="pointer-events: none;" class="inline"/></a> <a href="https://muwerk.github.io/munet/docs/index.html"><img src="https://img.shields.io/badge/docs-dev-blue.svg" alt="Dev Docs" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/muwerk/munet/actions"><img src="https://github.com/muwerk/munet/workflows/PlatformIO%20CI/badge.svg" alt="PlatformIO CI" style="pointer-events: none;" class="inline"/></a></p>
<p>The munet libraries use the <a href="https://github.com/muwerk/muwerk">muwerk scheduler</a> to provide a comprehensive set of network functionality: WiFi connection, Access Point Mode, NTP time sync, OTA software update and MQTT communication for ESP8266 and ESP32 chips with a minimum of code:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define __ESP__   // Platform define, add #define __ESP32__ for ESP32 (see dependencies)</div>
<div class="line">#include &quot;scheduler.h&quot;</div>
<div class="line">#include &quot;net.h&quot;</div>
<div class="line">#include &quot;mqtt.h&quot;</div>
<div class="line">#include &quot;ota.h&quot;</div>
<div class="line"> </div>
<div class="line">ustd::Scheduler sched;</div>
<div class="line">ustd::Net net(LED_BUILTIN);</div>
<div class="line">ustd::Mqtt mqtt;</div>
<div class="line">ustd::Ota ota;</div>
<div class="line"> </div>
<div class="line">void appLoop();</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">    net.begin(&amp;sched);  // connect to WiFi and sync NTP time, credentials read from ESP file system, (s.b.)</div>
<div class="line">    mqtt.begin(&amp;sched); // connect to MQTT server</div>
<div class="line">    ota.begin(&amp;sched);  // enable OTA updates</div>
<div class="line"> </div>
<div class="line">    int tID = sched.add(appLoop, &quot;main&quot;);  // create task for your app code</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void appLoop() {</div>
<div class="line">    // your code goes here.</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Never add code to this loop, use appLoop() instead.</div>
<div class="line">void loop() {</div>
<div class="line">    sched.loop();</div>
<div class="line">}</div>
</div><!-- fragment --><p>The library provides:</p>
<ul>
<li>WiFi station, access point or both using configuration data from LittleFS/SPIFFS file system (s.b.). Connection to the WiFi network is established automatically. The library handles reconnect and error recovery gracefully.</li>
<li>Over-the-air (OTA) update is supported with one line of code [optional]</li>
<li>Time synchronization with NTP servers, including daylight saving handling [optional]</li>
<li>Connection to an MQTT server (via PubSubClient) [optional] This transparently connects the pub/sub inter-task communication that is provided by the muwerk scheduler with extern MQTT publishers and subscribers. Messages between muwerk tasks are published to the external MQTT server, and muwerk tasks can transparently subscribe to both other tasks on the same ESP and external topics via the MQTT interface.</li>
<li>MCUs without network hardware can be connected to a second system with network hardware via a serial link (<code>MuSerial.h</code>). The two connected systems appear as one system to the outside world, both can publish/subscribe. pub/sub message synchronization is handled automatically via serial link.</li>
</ul>
<h1>Dependencies </h1>
<p>munet relies only on:</p>
<ul>
<li><a href="https://github.com/muwerk/ustd">ustd</a>. Check documentation for required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines</a>.</li>
<li><a href="https://github.com/muwerk/ustd">muwerk</a></li>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a></li>
<li><a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a>. <b>Note</b>: Earlier versions used a different lib: ArduinoJson.</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">munet component   </th><th class="markdownTableHeadNone">depends on ustd   </th><th class="markdownTableHeadNone">muwerk   </th><th class="markdownTableHeadNone">Arduino_JSON   </th><th class="markdownTableHeadNone">PubSubClient   </th><th class="markdownTableHeadNone">Network required   </th><th class="markdownTableHeadNone">Platforms    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Net.h   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">ESP8266, ESP32    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Ota.h   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">ESP8266, ESP32    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mqtt.h   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">ESP8266, ESP32    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MuSerial.h   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone">x   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">serial link between two muwerk nodes   </td><td class="markdownTableBodyNone">All (only serial port required)   </td></tr>
</table>
<h1>Breaking Changes at Version 0.3.0 </h1>
<p>All network classes in Version 3.0.0 have been deeply refactored in order to provide more functionality and better reliability. Nevertheless there are some breaking changes.</p>
<h2>Changed Method Signatures</h2>
<p><code><a class="el" href="classustd_1_1Net.html" title="munet, the muwerk network class for WiFi and NTP">ustd::Net</a></code> has now two different <code>Net::begin</code> methods. The default one (selected when invoking <code>net.begin(&amp;sched);</code>) starts the network based on configuration stored in a configuration file located at the filesystem of the device. If the device implements means for managing the configuration, this is the most versatile method. There is still a <code>Net::begin</code> method with a function signature similar to the older version that is intended for hardcoded devices. When starting the network with the other <code>Net::begin</code> method, the configuration is stored in memory and connot be changed any more at runtime.</p>
<p>Since the other network classes have also own configuration files when needed, the support for querying information about network services by publishing <code>net/services/get</code> has been removed.</p>
<p>The format of the <code>net/network/state</code> message has been extended to cover the new features, but is still compatible with older versions.</p>
<p>Also the interface of <code>Mqtt::begin</code> has changed in order to resemble the fact that all passed options are the defaults for options <b>not set</b> in the configuration file <code>mqtt.json</code>.</p>
<h2>Changed Configuration File Format</h2>
<p>When the device starts for the first time with the new <code>munet</code> library, it will detect an old configuration file and will migrate the content to the new format automatically. After the conversion, the filesystem will contain two configuration files:</p><ul>
<li><code>net.json</code> - the migrated version of the original net.json</li>
<li><code>mqtt.json</code> - the new configuration file for MQTT if the mqtt service was defined in the old configuration file.</li>
</ul>
<p>See the documentation below for details about the supported configuration options in each file.</p>
<h2>Retained Messages</h2>
<p>All messages published by the older version of <code><a class="el" href="classustd_1_1Mqtt.html" title="munet MQTT Gateway Class">ustd::Mqtt</a></code> were flagged with the <code>RETAINED</code> flag. This default behaviour has been changed: It is now possible to configure if the default behaviour should be to flag the messages or not. The default is <code>false</code> but if the configuration file was created by migrating an older <code>net.json</code>, the old behaviour will be preserved in order to maintain compatibility of the device (See configuration option <code>alwaysRetain</code> in <code>mqtt.json</code>).</p>
<p>When this option is <code>false</code> (the default setting), there is a new way (for explicit MQTT topics) to specify that a message shall be published as <code>RETAINED</code>: instead of prefixing the topic with one exclamation point, the topic shall be prefixed with double exclamation points. E.g.: <code>!!homeassistant/config</code>.</p>
<h1>Configuration </h1>
<p>All muwerk network and mqtt configuration is stored in <code>json</code> formatted files in the LittleFS/SPIFFS file system of the ESP chip. In order to initialize a filesystem on a specific device, create a directory in your local file system of your project named <code>data</code> and place all initial configuration files like <code>net.json</code> or <code>mqtt.json</code> there.</p>
<p>Using platformio, the initial file system containing all files in your <code>data</code> directory is saved to the ESP chip by executing the following commands:</p>
<div class="fragment"><div class="line">pio run -t buildfs</div>
<div class="line">pio run -t updatefs</div>
</div><!-- fragment --><p>'''Note:''' This project has moved from SPIFFS (deprecated) to LittleFS for ESP8266. To continue to use SPIFFS on ESP8266 systems, define <code>USTD_OPTION_FS_FORCE_SPIFFS</code>. See <a href="https://github.com/muwerk/ustd/blob/master/README.md#platform-defines">USTD</a> for more information about configuration options and platform defines.</p>
<p>In order to be able to create LittleFS file system images with platformio, your <code>platformio.ini</code> currently needs to contain:</p>
<div class="fragment"><div class="line">board_build.filesystem = littlefs</div>
</div><!-- fragment --><p>SPIFFS and LittleFS are not compatible, if the library is updated, a new file system needs to be created and upload with <code>pio run -t buildfs</code> and <code>pio run -t uploadfs</code>.</p>
<p>Since ESP32 currently does not (yet) support LittleFS, ESP32 projects automatically use SPIFFS for the time being.</p>
<h1>Minimal Required Configuration Files </h1>
<p>The following minimum configuration files are needed in order to connect to a WiFi network and have mqtt up and running.</p>
<h2>Minimum <code>net.json</code></h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;version&quot;: 1,</div>
<div class="line">    &quot;mode&quot;: &quot;station&quot;,</div>
<div class="line">    &quot;hostname&quot;: &quot;my-host-name&quot;,</div>
<div class="line">    &quot;station&quot;: {</div>
<div class="line">        &quot;SSID&quot;: &quot;my-network-SSID&quot;,</div>
<div class="line">        &quot;password&quot;: &quot;myS3cr3t&quot;</div>
<div class="line">    },</div>
<div class="line">    &quot;services&quot;: {</div>
<div class="line">        &quot;ntp&quot;: {</div>
<div class="line">            &quot;host&quot;: [&quot;time.nist.gov&quot;],</div>
<div class="line">            &quot;dstrules&quot;: &quot;CET-1CEST,M3.5.0,M10.5.0/3&quot;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Minimum <code>mqtt.json</code></h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;host&quot;:&quot;my-mqtt-hostname&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><h1>Network Configuration </h1>
<p>The network configuration is stored in a file named <code>net.json</code>.</p>
<h2>Sample <code>net.json</code></h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;version&quot;: 1,</div>
<div class="line">    &quot;mode&quot;: &quot;station&quot;,</div>
<div class="line">    &quot;hostname&quot;: &quot;muwerk-${macls}&quot;,</div>
<div class="line">    &quot;station&quot;: {</div>
<div class="line">        &quot;SSID&quot;: &quot;my-network-SSID&quot;,</div>
<div class="line">        &quot;password&quot;: &quot;myS3cr3t&quot;,</div>
<div class="line">        &quot;address&quot;: &quot;&quot;,</div>
<div class="line">        &quot;netmask&quot;: &quot;&quot;,</div>
<div class="line">        &quot;gateway&quot;: &quot;&quot;,</div>
<div class="line">        &quot;maxRetries&quot;: 40,</div>
<div class="line">        &quot;connectTimeout&quot;: 15,</div>
<div class="line">        &quot;rebootonFailure&quot;: true</div>
<div class="line">    },</div>
<div class="line">    &quot;ap&quot;: {</div>
<div class="line">        &quot;SSID&quot;: &quot;muwerk-${macls}&quot;,</div>
<div class="line">        &quot;password&quot;: &quot;&quot;,</div>
<div class="line">        &quot;address&quot;: &quot;&quot;,</div>
<div class="line">        &quot;netmask&quot;: &quot;&quot;,</div>
<div class="line">        &quot;gateway&quot;: &quot;&quot;,</div>
<div class="line">        &quot;channel&quot;: 1,</div>
<div class="line">        &quot;hidden&quot;: false</div>
<div class="line">    },</div>
<div class="line">    &quot;services&quot;: {</div>
<div class="line">        &quot;dns&quot;: {</div>
<div class="line">            &quot;host&quot;: []</div>
<div class="line">        },</div>
<div class="line">        &quot;ntp&quot;: {</div>
<div class="line">            &quot;host&quot;: [</div>
<div class="line">                &quot;time.nist.gov&quot;,</div>
<div class="line">                &quot;ptbtime1.ptb.de&quot;,</div>
<div class="line">                &quot;ptbtime2.ptb.de&quot;,</div>
<div class="line">                &quot;ptbtime3.ptb.de&quot;</div>
<div class="line">            ],</div>
<div class="line">            &quot;dstrules&quot;: &quot;CET-1CEST,M3.5.0,M10.5.0/3&quot;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configuration Options Placeholder</h2>
<p>Some of the configuration options support the use of placeholders in order to allow values that are specific to a certain devince without the need to create separate configuration files. Placeholders are written in the form of <code>${PLACEHOLDER}</code>.</p>
<p>The following options allow the the of placeholders:</p><ul>
<li>The <code>hostname</code> of the device. The default value of this hostname also uses a plceholder: <code>muwerk-${macls}</code></li>
<li>The <code>SSID</code> for access point mode. Also here the default value uses a plceholder: <code>muwerk-${macls}</code></li>
</ul>
<p>The following placeholders are currently available:</p><ul>
<li><code>mac</code>: full mac address</li>
<li><code>macls</code>: last 4 digits of mac address</li>
<li><code>macfs</code>: first 4 digits of mac address</li>
</ul>
<h2>Top Level Configuration Options</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>version</code>   </td><td class="markdownTableBodyNone">The configuration format version number. Current version is <code>1</code>. This field is mandatory.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>deviceID</code>   </td><td class="markdownTableBodyNone">Unique device ID - will be automatically generated and saved on first start. Useful when replacing a device    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>mode</code>   </td><td class="markdownTableBodyNone">Operating mode. Can be: <code>off</code>, <code>ap</code>, <code>station</code> or <code>both</code>. Default is <code>ap</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>hostname</code>   </td><td class="markdownTableBodyNone">Hostname the device will use and report to other services. May also be used to querythe DHCP server    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>ap</code>   </td><td class="markdownTableBodyNone">Configuration options for access point mode. See description below.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>station</code>   </td><td class="markdownTableBodyNone">Configuration options for network station mode. See description below.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>services</code>   </td><td class="markdownTableBodyNone">Configuration options for network services. See description below.   </td></tr>
</table>
<h3>Configuration Options for Access Point Mode</h3>
<p>The following options are stored in the <code>ap</code> object and apply to access point mode and dual mdoe.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SSID</code>   </td><td class="markdownTableBodyNone">Network name of the wireless network the ESP will host    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>password</code>   </td><td class="markdownTableBodyNone">Wireless network password    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>address</code>   </td><td class="markdownTableBodyNone">Static IP address. If not defined, the default of the library is taken - usually <code>192.168.4.1</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>netmask</code>   </td><td class="markdownTableBodyNone">Netmask of static IP address. Must be defined if <code>address</code> is also defined.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>gateway</code>   </td><td class="markdownTableBodyNone">Default gateway. Does not really make sense in AP mode, but must be specified.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>channel</code>   </td><td class="markdownTableBodyNone">Channel used for AP mode. If not specified, channel 1 is used.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>hidden</code>   </td><td class="markdownTableBodyNone">If <code>true</code>, the network created by the AP is hidden. Default is <code>false</code>   </td></tr>
</table>
<h3>Configuration Options for Network Station Mode</h3>
<p>The following options are stored in the <code>station</code> object and apply to network station mode and dual mdoe.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>SSID</code>   </td><td class="markdownTableBodyNone">Network name of the wireless network the ESP will join    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>password</code>   </td><td class="markdownTableBodyNone">Wireless network password    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>address</code>   </td><td class="markdownTableBodyNone">Static IP address. If not defined, the address is obtained via DHCP.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>netmask</code>   </td><td class="markdownTableBodyNone">Netmask of static IP address. Must be defined if <code>address</code> is also defined.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>gateway</code>   </td><td class="markdownTableBodyNone">Default gateway. Does not really make sense in AP mode, but must be specified.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>maxRetries</code>   </td><td class="markdownTableBodyNone">Maximum number of retries before giving up (and rebooting). Default is <code>40</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>connectTimeout</code>   </td><td class="markdownTableBodyNone">Connection timeout in seconds. Default is 15 seconds.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>rebootonFailure</code>   </td><td class="markdownTableBodyNone">If <code>true</code> the system reboots after reaching <code>maxRetries</code> connection failures. Default is <code>true</code>   </td></tr>
</table>
<h3>Configuration Options for Network Service DNS Client</h3>
<p>The DNS client is configured with an object named <code>dns</code> in the <code>services</code> object. The DNS client is only used in network station or dual mode.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>host</code>   </td><td class="markdownTableBodyNone">Array of hostnames/ip of DNS servers If empty the provided DHCP value is used   </td></tr>
</table>
<h3>Configuration Options for Network Service NTP Client</h3>
<p>The NTP client is configured with an object named <code>ntp</code> in the <code>services</code> object. The NTP client is only used in network station or dual mode.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>host</code>   </td><td class="markdownTableBodyNone">Array of hostnames/ip of NTP time servers from which the device synchronizes it's time. If empty the DHCP value is used    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>dstrules</code>   </td><td class="markdownTableBodyNone">optional timezone and daylight saving rules in <a href="https://mm.icann.org/pipermail/tz/2016-April/023570.html">unix format</a>   </td></tr>
</table>
<h1>Network Message Interface </h1>
<h2>Incoming</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Topic   </th><th class="markdownTableHeadNone">Message Body   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>net/network/get</code>   </td><td class="markdownTableBodyNone"></td><td class="markdownTableBodyNone">Returns a network information object in json format in a message with topic <code>net/network</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>net/network/control</code>   </td><td class="markdownTableBodyNone"><code>&lt;commands&gt;</code>   </td><td class="markdownTableBodyNone">Starts, stops or restarts the network (put <code>start</code>, <code>stop</code> or <code>restart</code> in the message body)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>net/networks/get</code>   </td><td class="markdownTableBodyNone"><code>&lt;options&gt;</code>   </td><td class="markdownTableBodyNone">Requests a WiFi network scan. The list is returned in a message with topic <code>net/networks</code>. The additional options <code>sync</code> and/or <code>hidden</code> can be sent in the body.   </td></tr>
</table>
<h2>Outgoing</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Topic   </th><th class="markdownTableHeadNone">Message Body   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>net/network</code>   </td><td class="markdownTableBodyNone"><code>{...}</code>   </td><td class="markdownTableBodyNone">The current network state as JSON object    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>net/rssi</code>   </td><td class="markdownTableBodyNone"><code>&lt;rssi value&gt;</code>   </td><td class="markdownTableBodyNone">The current signal value when connected to a WiFi    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>net/connections</code>   </td><td class="markdownTableBodyNone"><code>&lt;connection count&gt;</code>   </td><td class="markdownTableBodyNone">The number of stations connected to the device in access point mode    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>net/networks</code>   </td><td class="markdownTableBodyNone"><code>{..}</code>   </td><td class="markdownTableBodyNone">The result of a WiFi scan as JSON object   </td></tr>
</table>
<h1>MQTT Configuration </h1>
<p>The MQTT configuration is stored in a file named <code>mqtt.json</code>.</p>
<h2>Sample <code>mqtt.json</code></h2>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;host&quot;: &quot;192.168.107.1&quot;,</div>
<div class="line">    &quot;port&quot;: 1884,</div>
<div class="line">    &quot;user&quot;: &quot;&quot;,</div>
<div class="line">    &quot;password&quot;: &quot;&quot;,</div>
<div class="line">    &quot;clientName&quot;: &quot;${hostname}&quot;,</div>
<div class="line">    &quot;domainToken&quot;: &quot;mu&quot;,</div>
<div class="line">    &quot;outDomainToken&quot;: &quot;omu&quot;,</div>
<div class="line">    &quot;lastWillTopic&quot;: &quot;&quot;,</div>
<div class="line">    &quot;lastWillMessage&quot;: &quot;&quot;,</div>
<div class="line">    &quot;alwaysRetain&quot;: false,</div>
<div class="line">    &quot;subscriptions&quot;: [],</div>
<div class="line">    &quot;outgoingBlackList&quot;: [],</div>
<div class="line">    &quot;incomingBlackList&quot;: []</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configuration Options Placeholder</h2>
<p>Some of the configuration options support the use of placeholders in order to allow values that are specific to a certain devince without the need to create separate configuration files. Placeholders are written in the form of <code>${PLACEHOLDER}</code>.</p>
<p>The following options allow the the of placeholders:</p><ul>
<li>The <code>clientName</code> of the device. The default value uses a plceholder: <code>${hostname}</code></li>
<li>The <code>lastWillMessage</code> of the device.</li>
</ul>
<p>The following placeholders are currently available:</p><ul>
<li><code>mac</code>: full mac address</li>
<li><code>macls</code>: last 4 digits of mac address</li>
<li><code>macfs</code>: first 4 digits of mac address</li>
<li><code>hostname</code>: hostname of the device</li>
</ul>
<h2>Top Level Configuration Options</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Usage    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>host</code>   </td><td class="markdownTableBodyNone">Hostname or ip address of the MQTT server. This value is mandatory    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>port</code>   </td><td class="markdownTableBodyNone">Port number under which the MQTT server is reachable. (default: 1884)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>user</code>   </td><td class="markdownTableBodyNone">Username for mqtt server authentication. (default: empty for no authentication)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>password</code>   </td><td class="markdownTableBodyNone">Password for mqtt server authentication. (default: empty for no authentication)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>clientName</code>   </td><td class="markdownTableBodyNone">The unique MQTT client name. (default: <code>${hostname}</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>domainToken</code>   </td><td class="markdownTableBodyNone">Common domain token for device group. (default' <code>mu</code>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>outDomainToken</code>   </td><td class="markdownTableBodyNone">Domain token for outgoing messages. (default: <code>omu</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>lastWillTopic</code>   </td><td class="markdownTableBodyNone">Topic of MQTT last will message. (default: <code>&lt;outDomainName&gt;/&lt;clientName&gt;/mqtt/state</code>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>lastWillMessage</code>   </td><td class="markdownTableBodyNone">Message content for last will message. (default: <code>disconnected</code>)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>alwaysRetain</code>   </td><td class="markdownTableBodyNone">If <code>true</code> all messages published to MQQ will flagged as <code>RETAINED</code>. (default: <code>false</code>)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>subscriptions</code>   </td><td class="markdownTableBodyNone">List of additional subscription to route into the scheduler's message queue. (default: empty)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>outgoingBlackList</code>   </td><td class="markdownTableBodyNone">List of topics and topic wildcards that will not be published to the external server    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>incomingBlackList</code>   </td><td class="markdownTableBodyNone">List of topics and topic wildcards that will not be published to the muwerk scheduler's message queue   </td></tr>
</table>
<h1>MQTT Message Interface </h1>
<h2>Incoming</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Topic   </th><th class="markdownTableHeadNone">Message Body   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>mqtt/outgoingblock/set</code>   </td><td class="markdownTableBodyNone"><code>topic[-wildcard]</code>   </td><td class="markdownTableBodyNone">A topic or a topic wildcard for topics that should not be forwarded to the external mqtt server (e.g. to prevent message spam or routing problems)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>mqtt/outgoingblock/remove</code>   </td><td class="markdownTableBodyNone"><code>topic[-wildcard]</code>   </td><td class="markdownTableBodyNone">Remove a block on a given outgoing topic wildcard.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>mqtt/incomingblock/set</code>   </td><td class="markdownTableBodyNone"><code>topic[-wildcard]</code>   </td><td class="markdownTableBodyNone">A topic or a topic wildcard for topics that should not be forwarded from the external mqtt server to muwerk.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>mqtt/incomingblock/remove</code>   </td><td class="markdownTableBodyNone"><code>topic[-wildcard]</code>   </td><td class="markdownTableBodyNone">Remove a block on a given incoming topic wildcard.   </td></tr>
</table>
<h2>Outgoing</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Topic   </th><th class="markdownTableHeadNone">Message Body   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>mqtt/config</code>   </td><td class="markdownTableBodyNone"><code>&lt;prefix&gt;+&lt;will_topic&gt;+&lt;will_message&gt;</code>   </td><td class="markdownTableBodyNone">The message contains three parts separated bei <code>+</code>: prefix, the last-will-topic and last-will message. <code>prefix</code> is the mqtt topic-prefix automatically prefixed to outgoing messages, composed of <code>omu</code> (set with mqtt) and <code>hostname</code>, e.g. <code>omu/myhost</code>. <code>prefix</code> can be useful for mupplets to know the actual topic names that get published externally.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>mqtt/state</code>   </td><td class="markdownTableBodyNone"><code>connected</code> or <code>disconnected</code>   </td><td class="markdownTableBodyNone">muwerk processes that subscribe to <code>mqtt/state</code> are that way informed, if mqtt external connection is available. The <code>mqtt/state</code> topic with message <code>disconnected</code> is also the default configuration for mqtt's last will topic and message.   </td></tr>
</table>
<h1>MuSerial - exchange of MQTT pub/sub messages between two muwerk MCUs via serial link </h1>
<p>Two muwerk systems can be linked via a serial connection, if both run <code>MuSerial</code>. Pub/Sub Messages are exchanged transparently over the serial link. If one of the systems is connected to an external MQTT server, then both systems have access to MQTT pub/sub. To the outside, the system appears as one system, e.g. sensors or actors can be connected to either system, behaving identical to the outside world.</p>
<p>That way, a muwerk MCU without networking hardware can be connected to a network via a second muwerk system with network access via MuSerial.</p>
<p>See <a href="https://github.com/muwerk/examples/tree/master/serialBridge">Example SerialBridge</a> for a complete overview.</p>
<h1>History </h1>
<ul>
<li>0.4.0 (2021-01-30): <b>Breaking change</b> for ustd library include: ustd include-files have now <code>ustd_</code> prefix to prevent name-clashes with various platform-sdks. [queue.h clashed with ESP8266-Wifi, platform.h clashed with RISC-V SDK, hence new names <code>ustd_queue.h</code> and <code>ustd_platform.h</code> etc.]</li>
<li>0.3.2 (2021-01-29): MuSerial: MQTT-enable non-networked hardware via serial link, NTP Bugfix, MQTT connection state fix.<ul>
<li>Bugfix: NTP initialization on ESP8266 <a href="https://github.com/muwerk/munet/issues/6">failed often, #6</a>, due to unsafe parameter handling in current configTime() API of ESP8266, fixed.</li>
<li>MuSerial: MQTT-via-serial link between two muwerk MCUs to provide MQTT access to hardware without network via serial. MuSerial runs on all platforms and can be used to network-enable hardware via ESPs. See <a href="https://github.com/muwerk/examples/tree/master/serialBridge">SerialBridge</a>.</li>
<li>Fixed handling of mqtt connection state when network connection changes</li>
</ul>
</li>
<li>CI (2021-01-38): Github actions build-check for all supported platforms: network for ESPxx, serial for all others. <br  />
</li>
<li>0.3.1 (2021-01-20): Minor change: enable dependency-managment for Arduino library manager.</li>
<li>0.3.0 (2021-01-20): Next Generation Network: See section _"Breaking Changes at Version 0.3.0"_ for caveats.<ul>
<li>Support for Access Point mode and Dual Mode (both network station and access point mode)</li>
<li>Support for enhanced network scans (async and display of hidden networks)</li>
<li>Interface for controlling network operations (start, stop, restart)</li>
<li>Detailed and extensible configuration for network and MQTT</li>
<li>Support for controlling the <code>RETAINED</code> flag in published messages</li>
</ul>
</li>
<li>0.2.1 (2021-01-02): Small breaking change: the format of the <code>mqtt/state</code> has been simplified: the message contains either <code>connected</code> or <code>disconnected</code>. Configuration information has been moved into a separate message <code>mqtt/config</code>. Support for no outgoing domain prefix (no 'omu') fixed.</li>
<li>0.2.0 (2020-12-25): Initial support for LittleFS on ESP8266.</li>
<li>0.1.99 2020-09 (not yet released): Ongoing preparations for switch to LittleFS, since SPIFFS is deprecated.</li>
<li>0.1.11 (2019-12-27): New <a class="el" href="mqtt_8h_source.html">mqtt.h</a> api functions <code>addSubscription()</code>, <code>removeSubscription()</code> that allow to import additional topics from external MQTT server. See <a href="https://muwerk.github.io/munet/docs/classustd_1_1Mqtt.html">API doc</a> for details.</li>
<li>0.1.10 (2019-11-17): Add information about external prefix to <code>mqtt/state</code> messages. (HA registration of mupplets requirement)</li>
<li>0.1.9 (2019-11-17): Allow publishing to unmodified topics using <code>!</code> topic-prefix. Send internal messages with topic <code>mqtt/state</code></li>
<li>0.1.8 (2019-11-03): NTP Init was unreliable, fixed.</li>
<li>0.1.7 (2019-11-03): ESP32 crashes, if configTime() [for NTP setup] is called while WLAN is not connected. Fixes #2.</li>
<li>0.1.6 (2019-08-06): Outgoing messages (from ESP to MQTT server) are now prefixed by an additional outDomainToken in order to prevent recursions. Older versions did only prefix with ESP's hostname, but at the same time the ESP MQTT client also subscribes to topics starting with it's hostname. This design error caused duplicated messages.</li>
<li>0.1.5 (2019-07-24): This version uses <a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a> for JSON parsing. Older versions relied on outdated versions of the older library <code>ArduinoJson</code> which is no longer supported with <code>muwerk</code>.</li>
</ul>
<h1>Errata</h1>
<ul>
<li>MQTT doesn't seem to run stable with latest <code>PubSubClient</code> v2.8. It is recommended to use <code>PubSubClient@2.7</code> for the time being. This seems to affect both ESP8266 and ESP32</li>
</ul>
<h1>Documentation</h1>
<ul>
<li><a href="https://muwerk.github.io/munet/docs/index.html">ustd::munet documentation.</a></li>
<li><a href="https://muwerk.github.io/muwerk/docs/index.html">ustd::muwerk documentation.</a></li>
<li><code>ustd</code> required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines.</a></li>
<li><a href="https://muwerk.github.io/ustd/docs/index.html">ustd::ustd documentation.</a></li>
</ul>
<h1>ESP32 notes</h1>
<ul>
<li>In order to build MQTT for ESP32, PubSubClient v2.7 is needed (PubSubClient 2.8 crashes!).</li>
<li>SPIFFS filesystem: Optionally use this <a href="https://github.com/me-no-dev/arduino-esp32fs-plugin">Arduino plugin</a> to upload the SPIFFS filesystem to ESP32.</li>
</ul>
<h1>References</h1>
<ul>
<li><a href="https://github.com/muwerk/ustd">ustd</a> microWerk standard library</li>
<li><a href="https://github.com/muwerk/muwerk">muWerk</a> microWerk scheduler</li>
<li><a href="https://github.com/muwerk/mupplets">mupplets</a> sensor and io functionality blocks</li>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a> the excellent MQTT library used by munet.</li>
<li><a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a> JSON library for Arduino</li>
<li>Time zone rules: <a href="https://mm.icann.org/pipermail/tz/2016-April/023570.html">https://mm.icann.org/pipermail/tz/2016-April/023570.html</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
