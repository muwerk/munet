<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Munet ESP network library for muwerk scheduler: munet</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Munet ESP network library for muwerk scheduler
   </div>
   <div id="projectbrief">A muwerk network library for WLAN, NTP, OTA and MQTT support for ESP8266 and ESP32</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">munet </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.org/muwerk/munet"><img src="https://travis-ci.org/muwerk/munet.svg?branch=master" alt="ESP12e build" style="pointer-events: none;" class="inline"/></a> <a href="https://muwerk.github.io/munet/docs/index.html"><img src="https://img.shields.io/badge/docs-dev-blue.svg" alt="Dev Docs" style="pointer-events: none;" class="inline"/></a></p>
<p>The munet libraries use the <a href="https://github.com/muwerk/muwerk">muwerk scheduler</a> to provide a comprehensive set of network functionality: WLAN connection, NTP time sync, OTA software update and MQTT communication for ESP8266 and ESP32 chips with a minimum of code:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">#define __ESP__   // Platform define, add #define __ESP32__ for ESP32 (see dependencies)</div>
<div class="line">#include &quot;scheduler.h&quot;</div>
<div class="line">#include &quot;net.h&quot;</div>
<div class="line">#include &quot;mqtt.h&quot;</div>
<div class="line">#include &quot;ota.h&quot;</div>
<div class="line"> </div>
<div class="line">ustd::Scheduler sched;</div>
<div class="line">ustd::Net net(LED_BUILTIN);</div>
<div class="line">ustd::Mqtt mqtt;</div>
<div class="line">ustd::Ota ota;</div>
<div class="line"> </div>
<div class="line">void appLoop();</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">    net.begin(&amp;sched);  // connect to WLAN and sync NTP time, credentials read from ESP file system, (s.b.)</div>
<div class="line">    mqtt.begin(&amp;sched); // connect to MQTT server</div>
<div class="line">    ota.begin(&amp;sched);  // enable OTA updates</div>
<div class="line"> </div>
<div class="line">    int tID = sched.add(appLoop, &quot;main&quot;);  // create task for your app code</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">void appLoop() {</div>
<div class="line">    // your code goes here.</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">// Never add code to this loop, use appLoop() instead.</div>
<div class="line">void loop() {</div>
<div class="line">    sched.loop();</div>
<div class="line">}</div>
</div><!-- fragment --><p>The library provides:</p>
<ul>
<li>Network WLAN access, using credentials read from LittleFS/SPIFFS file system (s.b.), automatic connection to a WLAN is established. The library handles re-connect and error recovery gracefully.</li>
<li>Over-the-air (OTA) update is supported with one line of code [optional]</li>
<li>Time synchronization with NTP servers, including daylight saving handling [optional]</li>
<li>Connection to an MQTT server (via PubSubClient) [optional] This transparently connects the pub/sub inter-task communication that is provided by the muwerk scheduler with extern MQTT publishers and subscribers. Messages between muwerk tasks are published to the external MQTT server, and muwerk tasks can transparently subscribe to both other tasks on the same ESP and external topics via the MQTT interface.</li>
</ul>
<h1>Dependencies</h1>
<p>Munet relies only on:</p>
<ul>
<li><a href="https://github.com/muwerk/ustd">ustd</a>. Check documentation for required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines</a>.</li>
<li><a href="https://github.com/muwerk/ustd">muwerk</a></li>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a></li>
<li><a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a>. <b>Note</b>: Earlier versions used a different lib: ArduinoJson.</li>
</ul>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">munet component  </th><th class="markdownTableHeadNone">depends on ustd  </th><th class="markdownTableHeadNone">muwerk  </th><th class="markdownTableHeadNone">Arduino_JSON  </th><th class="markdownTableHeadNone">PubSubClient   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Net.h  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Ota.h  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Mqtt.h  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x  </td><td class="markdownTableBodyNone">x   </td></tr>
</table>
<h1>Configuration</h1>
<p>The network configuration is stored in a <code>json</code> formatted file <code>net.json</code> in the LittleFS/SPIFFS file system of the ESP chip. Create a copy in your local file system of your project at <code>data/net.json</code>.</p>
<p>'''Note:''' This project is currently preparing to move from SPIFFS (deprecated) to LittleFS. To continue to use SPIFFS, define <code>__USE_OLD_FS__</code>. In order to activate LittleFS, your <code>platformio.ini</code> currently needs to contain:</p>
<div class="fragment"><div class="line">board_build.filesystem = littlefs</div>
</div><!-- fragment --><p>SPIFFS and LittleFS are not compatible, if the library is updated, a new file system needs to be created and upload with <code>pio run -t buildfs</code> and <code>pio run -t uploadfs</code>.</p>
<p>Since ESP32 currently does not (yet) support LittleFS, ESP32 projects require the define <code>__USE_OLD_FS__</code> to continue to use SPIFFS for the time being.</p>
<h2>Sample <code>net.json</code></h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;SSID&quot;: &quot;my-network-SSID&quot;,</div>
<div class="line">  &quot;password&quot;: &quot;myS3cr3t&quot;,</div>
<div class="line">  &quot;hostname&quot;: &quot;myhost&quot;,</div>
<div class="line">  &quot;services&quot;: [</div>
<div class="line">    { &quot;timeserver&quot;: &quot;time.nist.gov&quot; },</div>
<div class="line">    { &quot;dstrules&quot;: &quot;CET-1CEST,M3.5.0,M10.5.0/3&quot; },</div>
<div class="line">    { &quot;mqttserver&quot;: &quot;my.mqtt.server&quot; }</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field  </th><th class="markdownTableHeadNone">Usage   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SSID  </td><td class="markdownTableBodyNone">Network name of the wireless network the ESP will join   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">password  </td><td class="markdownTableBodyNone">Wireless network password   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">hostname  </td><td class="markdownTableBodyNone">Hostname the ESP will try to register at the DHCP server   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">timeserver  </td><td class="markdownTableBodyNone">optional address of an NTP time server, if given, ESP time will be synchronized   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">dstrules  </td><td class="markdownTableBodyNone">optional timezone and daylight saving rules in <a href="https://mm.icann.org/pipermail/tz/2016-April/023570.html">unix format</a>   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">mqttserver  </td><td class="markdownTableBodyNone">optional address of MQTT server ESP connects to   </td></tr>
</table>
<p>Using platformio, <code>data/net.json</code> is saved to the ESP chip using:</p>
<div class="fragment"><div class="line">pio run -t buildfs</div>
<div class="line">pio run -t updatefs</div>
</div><!-- fragment --><h3>Internal Messages sent by munet to other muwerk processes:</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">topic  </th><th class="markdownTableHeadNone">message body  </th><th class="markdownTableHeadNone">comment   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>mqtt/config</code>  </td><td class="markdownTableBodyNone"><code>&lt;prefix&gt;+&lt;will_topic&gt;+&lt;will_message&gt;</code>  </td><td class="markdownTableBodyNone">The message contains three parts separated bei <code>+</code>: prefix, the last-will-topic and last-will message. <code>prefix</code> is the mqtt topic-prefix automatically prefixed to outgoing messages, composed of <code>omu</code> (set with mqtt) and <code>hostname</code>, e.g. <code>omu/myhost</code>. <code>prefix</code> can be useful for mupplets to know the actual topic names that get published externally.   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>mqtt/state</code>  </td><td class="markdownTableBodyNone"><code>connected</code> or <code>disconnected</code>  </td><td class="markdownTableBodyNone">muwerk processes that subscribe to <code>mqtt/state</code> are that way informed, if mqtt external connection is available. The <code>mqtt/state</code> topic with message <code>disconnected</code> is also the default configuration for mqtt's last will topic and message.   </td></tr>
</table>
<h1>History</h1>
<ul>
<li>0.2.1 (2021-01-02) : Small breaking change: the format of the <code>mqtt/state</code> has been simplified: the message contains either <code>connected</code> or <code>disconnected</code>. Configuration information has been moved into a separate message <code>mqtt/config</code>. Support for no outgoing domain prefix (no 'omu') fixed.</li>
<li>0.2.0 (2020-12-25): Initial support for LittleFS on ESP8266.</li>
<li>0.1.99 2020-09 (not yet released): Ongoing preparations for switch to LittleFS, since SPIFFS is deprecated.</li>
<li>0.1.11 (2019-12-27): New <a class="el" href="mqtt_8h.html">mqtt.h</a> api functions <code>addSubscription()</code>, <code>removeSubscription()</code> that allow to import additional topics from external MQTT server. See <a href="https://muwerk.github.io/munet/docs/classustd_1_1Mqtt.html">API doc</a> for details.</li>
<li>0.1.10 (2019-11-17): Add information about external prefix to <code>mqtt/state</code> messages. (HA registration of mupplets requirement)</li>
<li>0.1.9 (2019-11-17): Allow publishing to unmodified topics using <code>!</code> topic-prefix. Send internal messages with topic <code>mqtt/state</code></li>
<li>0.1.8 (2019-11-03): NTP Init was unreliable, fixed.</li>
<li>0.1.7 (2019-11-03): ESP32 crashes, if configTime() [for NTP setup] is called while WLAN is not connected. Fixes #2.</li>
<li>0.1.6 (2019-08-06): Outgoing messages (from ESP to MQTT server) are now prefixed by an additional outDomainToken in order to prevent recursions. Older versions did only prefix with ESP's hostname, but at the same time the ESP MQTT client also subscribes to topics starting with it's hostname. This design error caused duplicated messages.</li>
<li>0.1.5 (2019-07-24): This version uses <a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a> for JSON parsing. Older versions relied on outdated versions of the older library <code>ArduinoJson</code> which is no longer supported with <code>muwerk</code>.</li>
</ul>
<h1>Errata</h1>
<ul>
<li>MQTT doesn't seem to run stable with latest <code>PubSubClient</code> v2.8. It is recommended to use <code>PubSubClient@2.7</code> for the time being. This seems to affect both ESP8266 and ESP32</li>
</ul>
<h1>Documentation</h1>
<ul>
<li><a href="https://muwerk.github.io/munet/docs/index.html">ustd::munet documentation.</a></li>
<li><a href="https://muwerk.github.io/muwerk/docs/index.html">ustd::muwerk documentation.</a></li>
<li><code>ustd</code> required <a href="https://github.com/muwerk/ustd/blob/master/README.md">platform defines.</a></li>
<li><a href="https://muwerk.github.io/ustd/docs/index.html">ustd::ustd documentation.</a></li>
</ul>
<h1>ESP32 notes</h1>
<ul>
<li>In order to build MQTT for ESP32, PubSubClient v2.7 or newer is needed.</li>
<li>SPIFFS filesystem: Optionally use this <a href="https://github.com/me-no-dev/arduino-esp32fs-plugin">Arduino plugin</a> to upload the SPIFFS filesystem to ESP32.</li>
</ul>
<h1>References</h1>
<ul>
<li><a href="https://github.com/muwerk/ustd">ustd</a> microWerk standard library</li>
<li><a href="https://github.com/muwerk/muwerk">muWerk</a> microWerk scheduler</li>
<li><a href="https://github.com/muwerk/mupplets">mupplets</a> sensor and io functionality blocks</li>
<li><a href="https://github.com/knolleary/pubsubclient">PubSubClient</a> the excellent MQTT library used by munet.</li>
<li><a href="https://github.com/arduino-libraries/Arduino_JSON">Arduino_JSON</a> JSON library for Arduino</li>
<li>Time zone rules: <a href="https://mm.icann.org/pipermail/tz/2016-April/023570.html">https://mm.icann.org/pipermail/tz/2016-April/023570.html</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
